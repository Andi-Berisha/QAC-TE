"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _createEmotion = _interopRequireDefault(require("create-emotion"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _react = _interopRequireWildcard(require("react"));

var _AutoCenter = _interopRequireDefault(require("./AutoCenter"));

var _computeScrollLeft = _interopRequireDefault(require("./computeScrollLeft"));

var _createBasicStyleSet = _interopRequireDefault(require("./createBasicStyleSet"));

var _createCSSKey = _interopRequireDefault(require("./util/createCSSKey"));

var _FunctionContext = _interopRequireDefault(require("./FunctionContext"));

var _getView = _interopRequireDefault(require("./getView"));

var _InternalContext = _interopRequireDefault(require("./InternalContext"));

var _LegacyContext = _interopRequireDefault(require("./LegacyContext"));

var _patchStyleOptions = _interopRequireDefault(require("./patchStyleOptions"));

var _PropsContext = _interopRequireDefault(require("./PropsContext"));

var _useAnimateScrollLeft = _interopRequireDefault(require("./hooks/internal/useAnimateScrollLeft"));

var _useCallbackRefWithSubscribe = _interopRequireDefault(require("./hooks/internal/useCallbackRefWithSubscribe"));

var _useObserveScrollLeft = _interopRequireDefault(require("./hooks/internal/useObserveScrollLeft"));

var _ViewContext = _interopRequireDefault(require("./ViewContext"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

// We pool the emotion, so we don't create a new set of <style> for every component and reuse as much as we could.
var emotionPool = {};

var Composer = function Composer(_ref) {
  var children = _ref.children,
      dir = _ref.dir,
      height = _ref.height,
      nonce = _ref.nonce,
      numItems = _ref.numItems,
      styleOptions = _ref.styleOptions,
      styleSet = _ref.styleSet;
  dir = dir === 'ltr' || dir === 'rtl' ? dir : undefined;
  var patchedStyleOptions = (0, _react.useMemo)(function () {
    return (0, _patchStyleOptions.default)(styleOptions);
  }, [styleOptions]);
  var patchedStyleSet = (0, _react.useMemo)(function () {
    return styleSet || (0, _createBasicStyleSet.default)(patchedStyleOptions);
  }, [patchedStyleOptions, styleSet]);
  var styleSetClassNames = (0, _react.useMemo)(function () {
    var emotion = emotionPool[nonce] || (emotionPool[nonce] = (0, _createEmotion.default)({
      key: "react-film--css-".concat((0, _createCSSKey.default)()),
      nonce: nonce
    }));
    return Object.fromEntries(Object.entries(patchedStyleSet).map(function (_ref2) {
      var _ref3 = (0, _slicedToArray2.default)(_ref2, 2),
          name = _ref3[0],
          style = _ref3[1];

      return [name, emotion.css(style) + ''];
    }));
  }, [nonce, patchedStyleSet]);

  var _useState = (0, _react.useState)(),
      _useState2 = (0, _slicedToArray2.default)(_useState, 2),
      _ = _useState2[0],
      forceRender = _useState2[1];

  var itemContainerCallbackRefWithSubscribe = (0, _useCallbackRefWithSubscribe.default)();
  var scrollableCallbackRefWithSubscribe = (0, _useCallbackRefWithSubscribe.default)();
  var scrollLeftRef = (0, _react.useRef)(null);
  var scrollTimeoutRef = (0, _react.useRef)();
  (0, _react.useEffect)(function () {
    return function () {
      return clearTimeout(scrollTimeoutRef.current);
    };
  }, [scrollTimeoutRef]);
  var scrollTo = (0, _react.useCallback)(function (scrollFn) {
    var view = (0, _getView.default)(dir, scrollableCallbackRefWithSubscribe.current, itemContainerCallbackRefWithSubscribe.current, scrollLeftRef.current);

    if (view) {
      var index = view.index,
          indexFraction = view.indexFraction;
      var targetIndex = scrollFn({
        index: index,
        indexFraction: indexFraction
      });

      if (typeof targetIndex === 'number') {
        scrollLeftRef.current = (0, _computeScrollLeft.default)(dir, scrollableCallbackRefWithSubscribe.current, itemContainerCallbackRefWithSubscribe.current, targetIndex);
        forceRender({});
      }
    }
  }, [dir, forceRender, itemContainerCallbackRefWithSubscribe, scrollableCallbackRefWithSubscribe, scrollLeftRef]);
  var scrollOneLeft = (0, _react.useCallback)(function () {
    scrollTo(function (_ref4) {
      var indexFraction = _ref4.indexFraction;
      return dir === 'rtl' ? Math.floor(indexFraction) + 1 : Math.ceil(indexFraction) - 1;
    });
  }, [dir, scrollTo]);
  var scrollOneRight = (0, _react.useCallback)(function () {
    scrollTo(function (_ref5) {
      var indexFraction = _ref5.indexFraction;
      return dir === 'rtl' ? Math.ceil(indexFraction) - 1 : Math.floor(indexFraction) + 1;
    });
  }, [dir, scrollTo]);
  var functionContext = (0, _react.useMemo)(function () {
    return {
      scrollTo: scrollTo,
      scrollOneLeft: scrollOneLeft,
      scrollOneRight: scrollOneRight
    };
  }, [scrollTo, scrollOneLeft, scrollOneRight]);
  var internalContext = (0, _react.useMemo)(function () {
    return {
      itemContainerCallbackRefWithSubscribe: itemContainerCallbackRefWithSubscribe,
      scrollableCallbackRefWithSubscribe: scrollableCallbackRefWithSubscribe
    };
  }, [itemContainerCallbackRefWithSubscribe, scrollableCallbackRefWithSubscribe]);
  var propsContext = (0, _react.useMemo)(function () {
    return {
      dir: dir,
      height: height,
      nonce: nonce,
      numItems: numItems,
      styleOptions: patchedStyleOptions,
      styleSetClassNames: styleSetClassNames
    };
  }, [dir, height, nonce, numItems, patchedStyleOptions, styleSetClassNames]);

  var _useState3 = (0, _react.useState)({
    index: 0,
    indexFraction: 0,
    scrollBarPercentage: '0%',
    scrollBarWidth: '0%',
    scrolling: false
  }),
      _useState4 = (0, _slicedToArray2.default)(_useState3, 2),
      viewContext = _useState4[0],
      setViewContext = _useState4[1]; // This will setViewContext and reset the "scrolling" flag after a period of time.


  var setViewContext2 = (0, _react.useCallback)(function (nextViewContext) {
    setViewContext(nextViewContext);
    clearTimeout(scrollTimeoutRef.current);

    if (nextViewContext.scrolling) {
      scrollTimeoutRef.current = setTimeout(function () {
        return setViewContext(_objectSpread(_objectSpread({}, nextViewContext), {}, {
          scrolling: false
        }));
      }, 500);
    }
  }, [scrollTimeoutRef, setViewContext]);
  var handleScroll = (0, _react.useCallback)(function (_ref6) {
    var scrollBarPercentage = _ref6.fraction,
        initial = _ref6.initial,
        scrollBarWidth = _ref6.width;
    var view = (0, _getView.default)(dir, scrollableCallbackRefWithSubscribe.current, itemContainerCallbackRefWithSubscribe.current, scrollLeftRef.current);

    if (view) {
      var index = view.index,
          indexFraction = view.indexFraction;
      setViewContext2({
        index: index,
        indexFraction: indexFraction,
        scrolling: !initial,
        scrollBarPercentage: scrollBarPercentage,
        scrollBarWidth: scrollBarWidth
      });
    }
  }, [dir, itemContainerCallbackRefWithSubscribe, scrollableCallbackRefWithSubscribe, scrollLeftRef, setViewContext2]);
  var handleScrollToEnd = (0, _react.useCallback)(function () {
    scrollLeftRef.current = null;
    forceRender({});
  }, [forceRender, scrollLeftRef]);
  var legacyContext = (0, _react.useMemo)(function () {
    return _objectSpread(_objectSpread(_objectSpread(_objectSpread({}, functionContext), internalContext), propsContext), viewContext);
  }, [functionContext, internalContext, propsContext, viewContext]);
  (0, _useAnimateScrollLeft.default)(typeof scrollLeftRef.current === 'number' && scrollableCallbackRefWithSubscribe.current, scrollLeftRef.current, handleScrollToEnd);
  (0, _react.useEffect)(function () {
    return scrollableCallbackRefWithSubscribe.subscribe(function (current) {
      if (current) {
        current.addEventListener('pointerdown', handleScrollToEnd, {
          passive: true
        });
        return function () {
          return current.removeEventListener('pointerdown', handleScrollToEnd);
        };
      }
    });
  }, [scrollableCallbackRefWithSubscribe]);
  (0, _useObserveScrollLeft.default)(scrollableCallbackRefWithSubscribe, handleScroll);
  return /*#__PURE__*/_react.default.createElement(_PropsContext.default.Provider, {
    value: propsContext
  }, /*#__PURE__*/_react.default.createElement(_InternalContext.default.Provider, {
    value: internalContext
  }, /*#__PURE__*/_react.default.createElement(_FunctionContext.default.Provider, {
    value: functionContext
  }, /*#__PURE__*/_react.default.createElement(_ViewContext.default.Provider, {
    value: viewContext
  }, /*#__PURE__*/_react.default.createElement(_LegacyContext.default.Provider, {
    value: legacyContext
  }, children, patchedStyleOptions.autoCenter && /*#__PURE__*/_react.default.createElement(_AutoCenter.default, null))))));
};

Composer.defaultProps = {
  children: undefined,
  dir: undefined,
  height: undefined,
  nonce: undefined,
  styleOptions: undefined,
  styleSet: undefined
};
Composer.propTypes = {
  children: _propTypes.default.oneOfType([_propTypes.default.arrayOf(_propTypes.default.element), _propTypes.default.element]),
  dir: _propTypes.default.oneOf(['ltr', 'rtl']),
  height: _propTypes.default.number,
  nonce: _propTypes.default.string,
  numItems: _propTypes.default.number.isRequired,
  styleOptions: _propTypes.default.any,
  styleSet: _propTypes.default.any
};
var _default = Composer;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db21wb3Nlci5qcyJdLCJuYW1lcyI6WyJlbW90aW9uUG9vbCIsIkNvbXBvc2VyIiwiY2hpbGRyZW4iLCJkaXIiLCJoZWlnaHQiLCJub25jZSIsIm51bUl0ZW1zIiwic3R5bGVPcHRpb25zIiwic3R5bGVTZXQiLCJ1bmRlZmluZWQiLCJwYXRjaGVkU3R5bGVPcHRpb25zIiwicGF0Y2hlZFN0eWxlU2V0Iiwic3R5bGVTZXRDbGFzc05hbWVzIiwiZW1vdGlvbiIsImtleSIsIk9iamVjdCIsImZyb21FbnRyaWVzIiwiZW50cmllcyIsIm1hcCIsIm5hbWUiLCJzdHlsZSIsImNzcyIsIl8iLCJmb3JjZVJlbmRlciIsIml0ZW1Db250YWluZXJDYWxsYmFja1JlZldpdGhTdWJzY3JpYmUiLCJzY3JvbGxhYmxlQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlIiwic2Nyb2xsTGVmdFJlZiIsInNjcm9sbFRpbWVvdXRSZWYiLCJjbGVhclRpbWVvdXQiLCJjdXJyZW50Iiwic2Nyb2xsVG8iLCJzY3JvbGxGbiIsInZpZXciLCJpbmRleCIsImluZGV4RnJhY3Rpb24iLCJ0YXJnZXRJbmRleCIsInNjcm9sbE9uZUxlZnQiLCJNYXRoIiwiZmxvb3IiLCJjZWlsIiwic2Nyb2xsT25lUmlnaHQiLCJmdW5jdGlvbkNvbnRleHQiLCJpbnRlcm5hbENvbnRleHQiLCJwcm9wc0NvbnRleHQiLCJzY3JvbGxCYXJQZXJjZW50YWdlIiwic2Nyb2xsQmFyV2lkdGgiLCJzY3JvbGxpbmciLCJ2aWV3Q29udGV4dCIsInNldFZpZXdDb250ZXh0Iiwic2V0Vmlld0NvbnRleHQyIiwibmV4dFZpZXdDb250ZXh0Iiwic2V0VGltZW91dCIsImhhbmRsZVNjcm9sbCIsImZyYWN0aW9uIiwiaW5pdGlhbCIsIndpZHRoIiwiaGFuZGxlU2Nyb2xsVG9FbmQiLCJsZWdhY3lDb250ZXh0Iiwic3Vic2NyaWJlIiwiYWRkRXZlbnRMaXN0ZW5lciIsInBhc3NpdmUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwiYXV0b0NlbnRlciIsImRlZmF1bHRQcm9wcyIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsIm9uZU9mVHlwZSIsImFycmF5T2YiLCJlbGVtZW50Iiwib25lT2YiLCJudW1iZXIiLCJzdHJpbmciLCJpc1JlcXVpcmVkIiwiYW55Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRUE7QUFDQSxJQUFNQSxXQUFXLEdBQUcsRUFBcEI7O0FBRUEsSUFBTUMsUUFBUSxHQUFHLFNBQVhBLFFBQVcsT0FBd0U7QUFBQSxNQUFyRUMsUUFBcUUsUUFBckVBLFFBQXFFO0FBQUEsTUFBM0RDLEdBQTJELFFBQTNEQSxHQUEyRDtBQUFBLE1BQXREQyxNQUFzRCxRQUF0REEsTUFBc0Q7QUFBQSxNQUE5Q0MsS0FBOEMsUUFBOUNBLEtBQThDO0FBQUEsTUFBdkNDLFFBQXVDLFFBQXZDQSxRQUF1QztBQUFBLE1BQTdCQyxZQUE2QixRQUE3QkEsWUFBNkI7QUFBQSxNQUFmQyxRQUFlLFFBQWZBLFFBQWU7QUFDdkZMLEVBQUFBLEdBQUcsR0FBR0EsR0FBRyxLQUFLLEtBQVIsSUFBaUJBLEdBQUcsS0FBSyxLQUF6QixHQUFpQ0EsR0FBakMsR0FBdUNNLFNBQTdDO0FBRUEsTUFBTUMsbUJBQW1CLEdBQUcsb0JBQVE7QUFBQSxXQUFNLGdDQUFrQkgsWUFBbEIsQ0FBTjtBQUFBLEdBQVIsRUFBK0MsQ0FBQ0EsWUFBRCxDQUEvQyxDQUE1QjtBQUNBLE1BQU1JLGVBQWUsR0FBRyxvQkFBUTtBQUFBLFdBQU1ILFFBQVEsSUFBSSxrQ0FBb0JFLG1CQUFwQixDQUFsQjtBQUFBLEdBQVIsRUFBb0UsQ0FDMUZBLG1CQUQwRixFQUUxRkYsUUFGMEYsQ0FBcEUsQ0FBeEI7QUFLQSxNQUFNSSxrQkFBa0IsR0FBRyxvQkFBUSxZQUFNO0FBQ3ZDLFFBQU1DLE9BQU8sR0FDWGIsV0FBVyxDQUFDSyxLQUFELENBQVgsS0FBdUJMLFdBQVcsQ0FBQ0ssS0FBRCxDQUFYLEdBQXFCLDRCQUFjO0FBQUVTLE1BQUFBLEdBQUcsNEJBQXFCLDRCQUFyQixDQUFMO0FBQTRDVCxNQUFBQSxLQUFLLEVBQUxBO0FBQTVDLEtBQWQsQ0FBNUMsQ0FERjtBQUdBLFdBQU9VLE1BQU0sQ0FBQ0MsV0FBUCxDQUFtQkQsTUFBTSxDQUFDRSxPQUFQLENBQWVOLGVBQWYsRUFBZ0NPLEdBQWhDLENBQW9DO0FBQUE7QUFBQSxVQUFFQyxJQUFGO0FBQUEsVUFBUUMsS0FBUjs7QUFBQSxhQUFtQixDQUFDRCxJQUFELEVBQU9OLE9BQU8sQ0FBQ1EsR0FBUixDQUFZRCxLQUFaLElBQXFCLEVBQTVCLENBQW5CO0FBQUEsS0FBcEMsQ0FBbkIsQ0FBUDtBQUNELEdBTDBCLEVBS3hCLENBQUNmLEtBQUQsRUFBUU0sZUFBUixDQUx3QixDQUEzQjs7QUFUdUYsa0JBZ0I5RCxzQkFoQjhEO0FBQUE7QUFBQSxNQWdCaEZXLENBaEJnRjtBQUFBLE1BZ0I3RUMsV0FoQjZFOztBQWlCdkYsTUFBTUMscUNBQXFDLEdBQUcsMkNBQTlDO0FBQ0EsTUFBTUMsa0NBQWtDLEdBQUcsMkNBQTNDO0FBQ0EsTUFBTUMsYUFBYSxHQUFHLG1CQUFPLElBQVAsQ0FBdEI7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxvQkFBekI7QUFFQSx3QkFBVTtBQUFBLFdBQU07QUFBQSxhQUFNQyxZQUFZLENBQUNELGdCQUFnQixDQUFDRSxPQUFsQixDQUFsQjtBQUFBLEtBQU47QUFBQSxHQUFWLEVBQThELENBQUNGLGdCQUFELENBQTlEO0FBRUEsTUFBTUcsUUFBUSxHQUFHLHdCQUNmLFVBQUFDLFFBQVEsRUFBSTtBQUNWLFFBQU1DLElBQUksR0FBRyxzQkFDWDdCLEdBRFcsRUFFWHNCLGtDQUFrQyxDQUFDSSxPQUZ4QixFQUdYTCxxQ0FBcUMsQ0FBQ0ssT0FIM0IsRUFJWEgsYUFBYSxDQUFDRyxPQUpILENBQWI7O0FBT0EsUUFBSUcsSUFBSixFQUFVO0FBQUEsVUFDQUMsS0FEQSxHQUN5QkQsSUFEekIsQ0FDQUMsS0FEQTtBQUFBLFVBQ09DLGFBRFAsR0FDeUJGLElBRHpCLENBQ09FLGFBRFA7QUFFUixVQUFNQyxXQUFXLEdBQUdKLFFBQVEsQ0FBQztBQUFFRSxRQUFBQSxLQUFLLEVBQUxBLEtBQUY7QUFBU0MsUUFBQUEsYUFBYSxFQUFiQTtBQUFULE9BQUQsQ0FBNUI7O0FBRUEsVUFBSSxPQUFPQyxXQUFQLEtBQXVCLFFBQTNCLEVBQXFDO0FBQ25DVCxRQUFBQSxhQUFhLENBQUNHLE9BQWQsR0FBd0IsZ0NBQ3RCMUIsR0FEc0IsRUFFdEJzQixrQ0FBa0MsQ0FBQ0ksT0FGYixFQUd0QkwscUNBQXFDLENBQUNLLE9BSGhCLEVBSXRCTSxXQUpzQixDQUF4QjtBQU1BWixRQUFBQSxXQUFXLENBQUMsRUFBRCxDQUFYO0FBQ0Q7QUFDRjtBQUNGLEdBdkJjLEVBd0JmLENBQUNwQixHQUFELEVBQU1vQixXQUFOLEVBQW1CQyxxQ0FBbkIsRUFBMERDLGtDQUExRCxFQUE4RkMsYUFBOUYsQ0F4QmUsQ0FBakI7QUEyQkEsTUFBTVUsYUFBYSxHQUFHLHdCQUFZLFlBQU07QUFDdENOLElBQUFBLFFBQVEsQ0FBQztBQUFBLFVBQUdJLGFBQUgsU0FBR0EsYUFBSDtBQUFBLGFBQXdCL0IsR0FBRyxLQUFLLEtBQVIsR0FBZ0JrQyxJQUFJLENBQUNDLEtBQUwsQ0FBV0osYUFBWCxJQUE0QixDQUE1QyxHQUFnREcsSUFBSSxDQUFDRSxJQUFMLENBQVVMLGFBQVYsSUFBMkIsQ0FBbkc7QUFBQSxLQUFELENBQVI7QUFDRCxHQUZxQixFQUVuQixDQUFDL0IsR0FBRCxFQUFNMkIsUUFBTixDQUZtQixDQUF0QjtBQUlBLE1BQU1VLGNBQWMsR0FBRyx3QkFBWSxZQUFNO0FBQ3ZDVixJQUFBQSxRQUFRLENBQUM7QUFBQSxVQUFHSSxhQUFILFNBQUdBLGFBQUg7QUFBQSxhQUF3Qi9CLEdBQUcsS0FBSyxLQUFSLEdBQWdCa0MsSUFBSSxDQUFDRSxJQUFMLENBQVVMLGFBQVYsSUFBMkIsQ0FBM0MsR0FBK0NHLElBQUksQ0FBQ0MsS0FBTCxDQUFXSixhQUFYLElBQTRCLENBQW5HO0FBQUEsS0FBRCxDQUFSO0FBQ0QsR0FGc0IsRUFFcEIsQ0FBQy9CLEdBQUQsRUFBTTJCLFFBQU4sQ0FGb0IsQ0FBdkI7QUFJQSxNQUFNVyxlQUFlLEdBQUcsb0JBQ3RCO0FBQUEsV0FBTztBQUNMWCxNQUFBQSxRQUFRLEVBQVJBLFFBREs7QUFFTE0sTUFBQUEsYUFBYSxFQUFiQSxhQUZLO0FBR0xJLE1BQUFBLGNBQWMsRUFBZEE7QUFISyxLQUFQO0FBQUEsR0FEc0IsRUFNdEIsQ0FBQ1YsUUFBRCxFQUFXTSxhQUFYLEVBQTBCSSxjQUExQixDQU5zQixDQUF4QjtBQVNBLE1BQU1FLGVBQWUsR0FBRyxvQkFDdEI7QUFBQSxXQUFPO0FBQ0xsQixNQUFBQSxxQ0FBcUMsRUFBckNBLHFDQURLO0FBRUxDLE1BQUFBLGtDQUFrQyxFQUFsQ0E7QUFGSyxLQUFQO0FBQUEsR0FEc0IsRUFLdEIsQ0FBQ0QscUNBQUQsRUFBd0NDLGtDQUF4QyxDQUxzQixDQUF4QjtBQVFBLE1BQU1rQixZQUFZLEdBQUcsb0JBQ25CO0FBQUEsV0FBTztBQUFFeEMsTUFBQUEsR0FBRyxFQUFIQSxHQUFGO0FBQU9DLE1BQUFBLE1BQU0sRUFBTkEsTUFBUDtBQUFlQyxNQUFBQSxLQUFLLEVBQUxBLEtBQWY7QUFBc0JDLE1BQUFBLFFBQVEsRUFBUkEsUUFBdEI7QUFBZ0NDLE1BQUFBLFlBQVksRUFBRUcsbUJBQTlDO0FBQW1FRSxNQUFBQSxrQkFBa0IsRUFBbEJBO0FBQW5FLEtBQVA7QUFBQSxHQURtQixFQUVuQixDQUFDVCxHQUFELEVBQU1DLE1BQU4sRUFBY0MsS0FBZCxFQUFxQkMsUUFBckIsRUFBK0JJLG1CQUEvQixFQUFvREUsa0JBQXBELENBRm1CLENBQXJCOztBQTVFdUYsbUJBaUZqRCxxQkFBUztBQUM3Q3FCLElBQUFBLEtBQUssRUFBRSxDQURzQztBQUU3Q0MsSUFBQUEsYUFBYSxFQUFFLENBRjhCO0FBRzdDVSxJQUFBQSxtQkFBbUIsRUFBRSxJQUh3QjtBQUk3Q0MsSUFBQUEsY0FBYyxFQUFFLElBSjZCO0FBSzdDQyxJQUFBQSxTQUFTLEVBQUU7QUFMa0MsR0FBVCxDQWpGaUQ7QUFBQTtBQUFBLE1BaUZoRkMsV0FqRmdGO0FBQUEsTUFpRm5FQyxjQWpGbUUsa0JBeUZ2Rjs7O0FBQ0EsTUFBTUMsZUFBZSxHQUFHLHdCQUN0QixVQUFBQyxlQUFlLEVBQUk7QUFDakJGLElBQUFBLGNBQWMsQ0FBQ0UsZUFBRCxDQUFkO0FBRUF0QixJQUFBQSxZQUFZLENBQUNELGdCQUFnQixDQUFDRSxPQUFsQixDQUFaOztBQUVBLFFBQUlxQixlQUFlLENBQUNKLFNBQXBCLEVBQStCO0FBQzdCbkIsTUFBQUEsZ0JBQWdCLENBQUNFLE9BQWpCLEdBQTJCc0IsVUFBVSxDQUNuQztBQUFBLGVBQ0VILGNBQWMsaUNBQ1RFLGVBRFM7QUFFWkosVUFBQUEsU0FBUyxFQUFFO0FBRkMsV0FEaEI7QUFBQSxPQURtQyxFQU1uQyxHQU5tQyxDQUFyQztBQVFEO0FBQ0YsR0FoQnFCLEVBaUJ0QixDQUFDbkIsZ0JBQUQsRUFBbUJxQixjQUFuQixDQWpCc0IsQ0FBeEI7QUFvQkEsTUFBTUksWUFBWSxHQUFHLHdCQUNuQixpQkFBdUU7QUFBQSxRQUExRFIsbUJBQTBELFNBQXBFUyxRQUFvRTtBQUFBLFFBQXJDQyxPQUFxQyxTQUFyQ0EsT0FBcUM7QUFBQSxRQUFyQlQsY0FBcUIsU0FBNUJVLEtBQTRCO0FBQ3JFLFFBQU12QixJQUFJLEdBQUcsc0JBQ1g3QixHQURXLEVBRVhzQixrQ0FBa0MsQ0FBQ0ksT0FGeEIsRUFHWEwscUNBQXFDLENBQUNLLE9BSDNCLEVBSVhILGFBQWEsQ0FBQ0csT0FKSCxDQUFiOztBQU9BLFFBQUlHLElBQUosRUFBVTtBQUFBLFVBQ0FDLEtBREEsR0FDeUJELElBRHpCLENBQ0FDLEtBREE7QUFBQSxVQUNPQyxhQURQLEdBQ3lCRixJQUR6QixDQUNPRSxhQURQO0FBR1JlLE1BQUFBLGVBQWUsQ0FBQztBQUNkaEIsUUFBQUEsS0FBSyxFQUFMQSxLQURjO0FBRWRDLFFBQUFBLGFBQWEsRUFBYkEsYUFGYztBQUdkWSxRQUFBQSxTQUFTLEVBQUUsQ0FBQ1EsT0FIRTtBQUlkVixRQUFBQSxtQkFBbUIsRUFBbkJBLG1CQUpjO0FBS2RDLFFBQUFBLGNBQWMsRUFBZEE7QUFMYyxPQUFELENBQWY7QUFPRDtBQUNGLEdBcEJrQixFQXFCbkIsQ0FBQzFDLEdBQUQsRUFBTXFCLHFDQUFOLEVBQTZDQyxrQ0FBN0MsRUFBaUZDLGFBQWpGLEVBQWdHdUIsZUFBaEcsQ0FyQm1CLENBQXJCO0FBd0JBLE1BQU1PLGlCQUFpQixHQUFHLHdCQUFZLFlBQU07QUFDMUM5QixJQUFBQSxhQUFhLENBQUNHLE9BQWQsR0FBd0IsSUFBeEI7QUFDQU4sSUFBQUEsV0FBVyxDQUFDLEVBQUQsQ0FBWDtBQUNELEdBSHlCLEVBR3ZCLENBQUNBLFdBQUQsRUFBY0csYUFBZCxDQUh1QixDQUExQjtBQUtBLE1BQU0rQixhQUFhLEdBQUcsb0JBQ3BCO0FBQUEsdUVBQ0toQixlQURMLEdBRUtDLGVBRkwsR0FHS0MsWUFITCxHQUlLSSxXQUpMO0FBQUEsR0FEb0IsRUFPcEIsQ0FBQ04sZUFBRCxFQUFrQkMsZUFBbEIsRUFBbUNDLFlBQW5DLEVBQWlESSxXQUFqRCxDQVBvQixDQUF0QjtBQVVBLHFDQUNFLE9BQU9yQixhQUFhLENBQUNHLE9BQXJCLEtBQWlDLFFBQWpDLElBQTZDSixrQ0FBa0MsQ0FBQ0ksT0FEbEYsRUFFRUgsYUFBYSxDQUFDRyxPQUZoQixFQUdFMkIsaUJBSEY7QUFNQSx3QkFDRTtBQUFBLFdBQ0UvQixrQ0FBa0MsQ0FBQ2lDLFNBQW5DLENBQTZDLFVBQUE3QixPQUFPLEVBQUk7QUFDdEQsVUFBSUEsT0FBSixFQUFhO0FBQ1hBLFFBQUFBLE9BQU8sQ0FBQzhCLGdCQUFSLENBQXlCLGFBQXpCLEVBQXdDSCxpQkFBeEMsRUFBMkQ7QUFBRUksVUFBQUEsT0FBTyxFQUFFO0FBQVgsU0FBM0Q7QUFFQSxlQUFPO0FBQUEsaUJBQU0vQixPQUFPLENBQUNnQyxtQkFBUixDQUE0QixhQUE1QixFQUEyQ0wsaUJBQTNDLENBQU47QUFBQSxTQUFQO0FBQ0Q7QUFDRixLQU5ELENBREY7QUFBQSxHQURGLEVBU0UsQ0FBQy9CLGtDQUFELENBVEY7QUFZQSxxQ0FBcUJBLGtDQUFyQixFQUF5RDJCLFlBQXpEO0FBRUEsc0JBQ0UsNkJBQUMscUJBQUQsQ0FBYyxRQUFkO0FBQXVCLElBQUEsS0FBSyxFQUFFVDtBQUE5QixrQkFDRSw2QkFBQyx3QkFBRCxDQUFpQixRQUFqQjtBQUEwQixJQUFBLEtBQUssRUFBRUQ7QUFBakMsa0JBQ0UsNkJBQUMsd0JBQUQsQ0FBaUIsUUFBakI7QUFBMEIsSUFBQSxLQUFLLEVBQUVEO0FBQWpDLGtCQUNFLDZCQUFDLG9CQUFELENBQWEsUUFBYjtBQUFzQixJQUFBLEtBQUssRUFBRU07QUFBN0Isa0JBQ0UsNkJBQUMsc0JBQUQsQ0FBZSxRQUFmO0FBQXdCLElBQUEsS0FBSyxFQUFFVTtBQUEvQixLQUNHdkQsUUFESCxFQUVHUSxtQkFBbUIsQ0FBQ29ELFVBQXBCLGlCQUFrQyw2QkFBQyxtQkFBRCxPQUZyQyxDQURGLENBREYsQ0FERixDQURGLENBREY7QUFjRCxDQXZMRDs7QUF5TEE3RCxRQUFRLENBQUM4RCxZQUFULEdBQXdCO0FBQ3RCN0QsRUFBQUEsUUFBUSxFQUFFTyxTQURZO0FBRXRCTixFQUFBQSxHQUFHLEVBQUVNLFNBRmlCO0FBR3RCTCxFQUFBQSxNQUFNLEVBQUVLLFNBSGM7QUFJdEJKLEVBQUFBLEtBQUssRUFBRUksU0FKZTtBQUt0QkYsRUFBQUEsWUFBWSxFQUFFRSxTQUxRO0FBTXRCRCxFQUFBQSxRQUFRLEVBQUVDO0FBTlksQ0FBeEI7QUFTQVIsUUFBUSxDQUFDK0QsU0FBVCxHQUFxQjtBQUNuQjlELEVBQUFBLFFBQVEsRUFBRStELG1CQUFVQyxTQUFWLENBQW9CLENBQUNELG1CQUFVRSxPQUFWLENBQWtCRixtQkFBVUcsT0FBNUIsQ0FBRCxFQUF1Q0gsbUJBQVVHLE9BQWpELENBQXBCLENBRFM7QUFFbkJqRSxFQUFBQSxHQUFHLEVBQUU4RCxtQkFBVUksS0FBVixDQUFnQixDQUFDLEtBQUQsRUFBUSxLQUFSLENBQWhCLENBRmM7QUFHbkJqRSxFQUFBQSxNQUFNLEVBQUU2RCxtQkFBVUssTUFIQztBQUluQmpFLEVBQUFBLEtBQUssRUFBRTRELG1CQUFVTSxNQUpFO0FBS25CakUsRUFBQUEsUUFBUSxFQUFFMkQsbUJBQVVLLE1BQVYsQ0FBaUJFLFVBTFI7QUFNbkJqRSxFQUFBQSxZQUFZLEVBQUUwRCxtQkFBVVEsR0FOTDtBQU9uQmpFLEVBQUFBLFFBQVEsRUFBRXlELG1CQUFVUTtBQVBELENBQXJCO2VBVWV4RSxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNyZWF0ZUVtb3Rpb24gZnJvbSAnY3JlYXRlLWVtb3Rpb24nO1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJztcbmltcG9ydCBSZWFjdCwgeyB1c2VDYWxsYmFjaywgdXNlRWZmZWN0LCB1c2VNZW1vLCB1c2VSZWYsIHVzZVN0YXRlIH0gZnJvbSAncmVhY3QnO1xuXG5pbXBvcnQgQXV0b0NlbnRlciBmcm9tICcuL0F1dG9DZW50ZXInO1xuaW1wb3J0IGNvbXB1dGVTY3JvbGxMZWZ0IGZyb20gJy4vY29tcHV0ZVNjcm9sbExlZnQnO1xuaW1wb3J0IGNyZWF0ZUJhc2ljU3R5bGVTZXQgZnJvbSAnLi9jcmVhdGVCYXNpY1N0eWxlU2V0JztcbmltcG9ydCBjcmVhdGVDU1NLZXkgZnJvbSAnLi91dGlsL2NyZWF0ZUNTU0tleSc7XG5pbXBvcnQgRnVuY3Rpb25Db250ZXh0IGZyb20gJy4vRnVuY3Rpb25Db250ZXh0JztcbmltcG9ydCBnZXRWaWV3IGZyb20gJy4vZ2V0Vmlldyc7XG5pbXBvcnQgSW50ZXJuYWxDb250ZXh0IGZyb20gJy4vSW50ZXJuYWxDb250ZXh0JztcbmltcG9ydCBMZWdhY3lDb250ZXh0IGZyb20gJy4vTGVnYWN5Q29udGV4dCc7XG5pbXBvcnQgcGF0Y2hTdHlsZU9wdGlvbnMgZnJvbSAnLi9wYXRjaFN0eWxlT3B0aW9ucyc7XG5pbXBvcnQgUHJvcHNDb250ZXh0IGZyb20gJy4vUHJvcHNDb250ZXh0JztcbmltcG9ydCB1c2VBbmltYXRlU2Nyb2xsTGVmdCBmcm9tICcuL2hvb2tzL2ludGVybmFsL3VzZUFuaW1hdGVTY3JvbGxMZWZ0JztcbmltcG9ydCB1c2VDYWxsYmFja1JlZldpdGhTdWJzY3JpYmUgZnJvbSAnLi9ob29rcy9pbnRlcm5hbC91c2VDYWxsYmFja1JlZldpdGhTdWJzY3JpYmUnO1xuaW1wb3J0IHVzZU9ic2VydmVTY3JvbGxMZWZ0IGZyb20gJy4vaG9va3MvaW50ZXJuYWwvdXNlT2JzZXJ2ZVNjcm9sbExlZnQnO1xuaW1wb3J0IFZpZXdDb250ZXh0IGZyb20gJy4vVmlld0NvbnRleHQnO1xuXG4vLyBXZSBwb29sIHRoZSBlbW90aW9uLCBzbyB3ZSBkb24ndCBjcmVhdGUgYSBuZXcgc2V0IG9mIDxzdHlsZT4gZm9yIGV2ZXJ5IGNvbXBvbmVudCBhbmQgcmV1c2UgYXMgbXVjaCBhcyB3ZSBjb3VsZC5cbmNvbnN0IGVtb3Rpb25Qb29sID0ge307XG5cbmNvbnN0IENvbXBvc2VyID0gKHsgY2hpbGRyZW4sIGRpciwgaGVpZ2h0LCBub25jZSwgbnVtSXRlbXMsIHN0eWxlT3B0aW9ucywgc3R5bGVTZXQgfSkgPT4ge1xuICBkaXIgPSBkaXIgPT09ICdsdHInIHx8IGRpciA9PT0gJ3J0bCcgPyBkaXIgOiB1bmRlZmluZWQ7XG5cbiAgY29uc3QgcGF0Y2hlZFN0eWxlT3B0aW9ucyA9IHVzZU1lbW8oKCkgPT4gcGF0Y2hTdHlsZU9wdGlvbnMoc3R5bGVPcHRpb25zKSwgW3N0eWxlT3B0aW9uc10pO1xuICBjb25zdCBwYXRjaGVkU3R5bGVTZXQgPSB1c2VNZW1vKCgpID0+IHN0eWxlU2V0IHx8IGNyZWF0ZUJhc2ljU3R5bGVTZXQocGF0Y2hlZFN0eWxlT3B0aW9ucyksIFtcbiAgICBwYXRjaGVkU3R5bGVPcHRpb25zLFxuICAgIHN0eWxlU2V0XG4gIF0pO1xuXG4gIGNvbnN0IHN0eWxlU2V0Q2xhc3NOYW1lcyA9IHVzZU1lbW8oKCkgPT4ge1xuICAgIGNvbnN0IGVtb3Rpb24gPVxuICAgICAgZW1vdGlvblBvb2xbbm9uY2VdIHx8IChlbW90aW9uUG9vbFtub25jZV0gPSBjcmVhdGVFbW90aW9uKHsga2V5OiBgcmVhY3QtZmlsbS0tY3NzLSR7Y3JlYXRlQ1NTS2V5KCl9YCwgbm9uY2UgfSkpO1xuXG4gICAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhPYmplY3QuZW50cmllcyhwYXRjaGVkU3R5bGVTZXQpLm1hcCgoW25hbWUsIHN0eWxlXSkgPT4gW25hbWUsIGVtb3Rpb24uY3NzKHN0eWxlKSArICcnXSkpO1xuICB9LCBbbm9uY2UsIHBhdGNoZWRTdHlsZVNldF0pO1xuXG4gIGNvbnN0IFtfLCBmb3JjZVJlbmRlcl0gPSB1c2VTdGF0ZSgpO1xuICBjb25zdCBpdGVtQ29udGFpbmVyQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlID0gdXNlQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlKCk7XG4gIGNvbnN0IHNjcm9sbGFibGVDYWxsYmFja1JlZldpdGhTdWJzY3JpYmUgPSB1c2VDYWxsYmFja1JlZldpdGhTdWJzY3JpYmUoKTtcbiAgY29uc3Qgc2Nyb2xsTGVmdFJlZiA9IHVzZVJlZihudWxsKTtcbiAgY29uc3Qgc2Nyb2xsVGltZW91dFJlZiA9IHVzZVJlZigpO1xuXG4gIHVzZUVmZmVjdCgoKSA9PiAoKSA9PiBjbGVhclRpbWVvdXQoc2Nyb2xsVGltZW91dFJlZi5jdXJyZW50KSwgW3Njcm9sbFRpbWVvdXRSZWZdKTtcblxuICBjb25zdCBzY3JvbGxUbyA9IHVzZUNhbGxiYWNrKFxuICAgIHNjcm9sbEZuID0+IHtcbiAgICAgIGNvbnN0IHZpZXcgPSBnZXRWaWV3KFxuICAgICAgICBkaXIsXG4gICAgICAgIHNjcm9sbGFibGVDYWxsYmFja1JlZldpdGhTdWJzY3JpYmUuY3VycmVudCxcbiAgICAgICAgaXRlbUNvbnRhaW5lckNhbGxiYWNrUmVmV2l0aFN1YnNjcmliZS5jdXJyZW50LFxuICAgICAgICBzY3JvbGxMZWZ0UmVmLmN1cnJlbnRcbiAgICAgICk7XG5cbiAgICAgIGlmICh2aWV3KSB7XG4gICAgICAgIGNvbnN0IHsgaW5kZXgsIGluZGV4RnJhY3Rpb24gfSA9IHZpZXc7XG4gICAgICAgIGNvbnN0IHRhcmdldEluZGV4ID0gc2Nyb2xsRm4oeyBpbmRleCwgaW5kZXhGcmFjdGlvbiB9KTtcblxuICAgICAgICBpZiAodHlwZW9mIHRhcmdldEluZGV4ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgIHNjcm9sbExlZnRSZWYuY3VycmVudCA9IGNvbXB1dGVTY3JvbGxMZWZ0KFxuICAgICAgICAgICAgZGlyLFxuICAgICAgICAgICAgc2Nyb2xsYWJsZUNhbGxiYWNrUmVmV2l0aFN1YnNjcmliZS5jdXJyZW50LFxuICAgICAgICAgICAgaXRlbUNvbnRhaW5lckNhbGxiYWNrUmVmV2l0aFN1YnNjcmliZS5jdXJyZW50LFxuICAgICAgICAgICAgdGFyZ2V0SW5kZXhcbiAgICAgICAgICApO1xuICAgICAgICAgIGZvcmNlUmVuZGVyKHt9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0sXG4gICAgW2RpciwgZm9yY2VSZW5kZXIsIGl0ZW1Db250YWluZXJDYWxsYmFja1JlZldpdGhTdWJzY3JpYmUsIHNjcm9sbGFibGVDYWxsYmFja1JlZldpdGhTdWJzY3JpYmUsIHNjcm9sbExlZnRSZWZdXG4gICk7XG5cbiAgY29uc3Qgc2Nyb2xsT25lTGVmdCA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBzY3JvbGxUbygoeyBpbmRleEZyYWN0aW9uIH0pID0+IChkaXIgPT09ICdydGwnID8gTWF0aC5mbG9vcihpbmRleEZyYWN0aW9uKSArIDEgOiBNYXRoLmNlaWwoaW5kZXhGcmFjdGlvbikgLSAxKSk7XG4gIH0sIFtkaXIsIHNjcm9sbFRvXSk7XG5cbiAgY29uc3Qgc2Nyb2xsT25lUmlnaHQgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgc2Nyb2xsVG8oKHsgaW5kZXhGcmFjdGlvbiB9KSA9PiAoZGlyID09PSAncnRsJyA/IE1hdGguY2VpbChpbmRleEZyYWN0aW9uKSAtIDEgOiBNYXRoLmZsb29yKGluZGV4RnJhY3Rpb24pICsgMSkpO1xuICB9LCBbZGlyLCBzY3JvbGxUb10pO1xuXG4gIGNvbnN0IGZ1bmN0aW9uQ29udGV4dCA9IHVzZU1lbW8oXG4gICAgKCkgPT4gKHtcbiAgICAgIHNjcm9sbFRvLFxuICAgICAgc2Nyb2xsT25lTGVmdCxcbiAgICAgIHNjcm9sbE9uZVJpZ2h0XG4gICAgfSksXG4gICAgW3Njcm9sbFRvLCBzY3JvbGxPbmVMZWZ0LCBzY3JvbGxPbmVSaWdodF1cbiAgKTtcblxuICBjb25zdCBpbnRlcm5hbENvbnRleHQgPSB1c2VNZW1vKFxuICAgICgpID0+ICh7XG4gICAgICBpdGVtQ29udGFpbmVyQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlLFxuICAgICAgc2Nyb2xsYWJsZUNhbGxiYWNrUmVmV2l0aFN1YnNjcmliZVxuICAgIH0pLFxuICAgIFtpdGVtQ29udGFpbmVyQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlLCBzY3JvbGxhYmxlQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlXVxuICApO1xuXG4gIGNvbnN0IHByb3BzQ29udGV4dCA9IHVzZU1lbW8oXG4gICAgKCkgPT4gKHsgZGlyLCBoZWlnaHQsIG5vbmNlLCBudW1JdGVtcywgc3R5bGVPcHRpb25zOiBwYXRjaGVkU3R5bGVPcHRpb25zLCBzdHlsZVNldENsYXNzTmFtZXMgfSksXG4gICAgW2RpciwgaGVpZ2h0LCBub25jZSwgbnVtSXRlbXMsIHBhdGNoZWRTdHlsZU9wdGlvbnMsIHN0eWxlU2V0Q2xhc3NOYW1lc11cbiAgKTtcblxuICBjb25zdCBbdmlld0NvbnRleHQsIHNldFZpZXdDb250ZXh0XSA9IHVzZVN0YXRlKHtcbiAgICBpbmRleDogMCxcbiAgICBpbmRleEZyYWN0aW9uOiAwLFxuICAgIHNjcm9sbEJhclBlcmNlbnRhZ2U6ICcwJScsXG4gICAgc2Nyb2xsQmFyV2lkdGg6ICcwJScsXG4gICAgc2Nyb2xsaW5nOiBmYWxzZVxuICB9KTtcblxuICAvLyBUaGlzIHdpbGwgc2V0Vmlld0NvbnRleHQgYW5kIHJlc2V0IHRoZSBcInNjcm9sbGluZ1wiIGZsYWcgYWZ0ZXIgYSBwZXJpb2Qgb2YgdGltZS5cbiAgY29uc3Qgc2V0Vmlld0NvbnRleHQyID0gdXNlQ2FsbGJhY2soXG4gICAgbmV4dFZpZXdDb250ZXh0ID0+IHtcbiAgICAgIHNldFZpZXdDb250ZXh0KG5leHRWaWV3Q29udGV4dCk7XG5cbiAgICAgIGNsZWFyVGltZW91dChzY3JvbGxUaW1lb3V0UmVmLmN1cnJlbnQpO1xuXG4gICAgICBpZiAobmV4dFZpZXdDb250ZXh0LnNjcm9sbGluZykge1xuICAgICAgICBzY3JvbGxUaW1lb3V0UmVmLmN1cnJlbnQgPSBzZXRUaW1lb3V0KFxuICAgICAgICAgICgpID0+XG4gICAgICAgICAgICBzZXRWaWV3Q29udGV4dCh7XG4gICAgICAgICAgICAgIC4uLm5leHRWaWV3Q29udGV4dCxcbiAgICAgICAgICAgICAgc2Nyb2xsaW5nOiBmYWxzZVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgNTAwXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfSxcbiAgICBbc2Nyb2xsVGltZW91dFJlZiwgc2V0Vmlld0NvbnRleHRdXG4gICk7XG5cbiAgY29uc3QgaGFuZGxlU2Nyb2xsID0gdXNlQ2FsbGJhY2soXG4gICAgKHsgZnJhY3Rpb246IHNjcm9sbEJhclBlcmNlbnRhZ2UsIGluaXRpYWwsIHdpZHRoOiBzY3JvbGxCYXJXaWR0aCB9KSA9PiB7XG4gICAgICBjb25zdCB2aWV3ID0gZ2V0VmlldyhcbiAgICAgICAgZGlyLFxuICAgICAgICBzY3JvbGxhYmxlQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlLmN1cnJlbnQsXG4gICAgICAgIGl0ZW1Db250YWluZXJDYWxsYmFja1JlZldpdGhTdWJzY3JpYmUuY3VycmVudCxcbiAgICAgICAgc2Nyb2xsTGVmdFJlZi5jdXJyZW50XG4gICAgICApO1xuXG4gICAgICBpZiAodmlldykge1xuICAgICAgICBjb25zdCB7IGluZGV4LCBpbmRleEZyYWN0aW9uIH0gPSB2aWV3O1xuXG4gICAgICAgIHNldFZpZXdDb250ZXh0Mih7XG4gICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgaW5kZXhGcmFjdGlvbixcbiAgICAgICAgICBzY3JvbGxpbmc6ICFpbml0aWFsLFxuICAgICAgICAgIHNjcm9sbEJhclBlcmNlbnRhZ2UsXG4gICAgICAgICAgc2Nyb2xsQmFyV2lkdGhcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSxcbiAgICBbZGlyLCBpdGVtQ29udGFpbmVyQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlLCBzY3JvbGxhYmxlQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlLCBzY3JvbGxMZWZ0UmVmLCBzZXRWaWV3Q29udGV4dDJdXG4gICk7XG5cbiAgY29uc3QgaGFuZGxlU2Nyb2xsVG9FbmQgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgc2Nyb2xsTGVmdFJlZi5jdXJyZW50ID0gbnVsbDtcbiAgICBmb3JjZVJlbmRlcih7fSk7XG4gIH0sIFtmb3JjZVJlbmRlciwgc2Nyb2xsTGVmdFJlZl0pO1xuXG4gIGNvbnN0IGxlZ2FjeUNvbnRleHQgPSB1c2VNZW1vKFxuICAgICgpID0+ICh7XG4gICAgICAuLi5mdW5jdGlvbkNvbnRleHQsXG4gICAgICAuLi5pbnRlcm5hbENvbnRleHQsXG4gICAgICAuLi5wcm9wc0NvbnRleHQsXG4gICAgICAuLi52aWV3Q29udGV4dFxuICAgIH0pLFxuICAgIFtmdW5jdGlvbkNvbnRleHQsIGludGVybmFsQ29udGV4dCwgcHJvcHNDb250ZXh0LCB2aWV3Q29udGV4dF1cbiAgKTtcblxuICB1c2VBbmltYXRlU2Nyb2xsTGVmdChcbiAgICB0eXBlb2Ygc2Nyb2xsTGVmdFJlZi5jdXJyZW50ID09PSAnbnVtYmVyJyAmJiBzY3JvbGxhYmxlQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlLmN1cnJlbnQsXG4gICAgc2Nyb2xsTGVmdFJlZi5jdXJyZW50LFxuICAgIGhhbmRsZVNjcm9sbFRvRW5kXG4gICk7XG5cbiAgdXNlRWZmZWN0KFxuICAgICgpID0+XG4gICAgICBzY3JvbGxhYmxlQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlLnN1YnNjcmliZShjdXJyZW50ID0+IHtcbiAgICAgICAgaWYgKGN1cnJlbnQpIHtcbiAgICAgICAgICBjdXJyZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgaGFuZGxlU2Nyb2xsVG9FbmQsIHsgcGFzc2l2ZTogdHJ1ZSB9KTtcblxuICAgICAgICAgIHJldHVybiAoKSA9PiBjdXJyZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgaGFuZGxlU2Nyb2xsVG9FbmQpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICBbc2Nyb2xsYWJsZUNhbGxiYWNrUmVmV2l0aFN1YnNjcmliZV1cbiAgKTtcblxuICB1c2VPYnNlcnZlU2Nyb2xsTGVmdChzY3JvbGxhYmxlQ2FsbGJhY2tSZWZXaXRoU3Vic2NyaWJlLCBoYW5kbGVTY3JvbGwpO1xuXG4gIHJldHVybiAoXG4gICAgPFByb3BzQ29udGV4dC5Qcm92aWRlciB2YWx1ZT17cHJvcHNDb250ZXh0fT5cbiAgICAgIDxJbnRlcm5hbENvbnRleHQuUHJvdmlkZXIgdmFsdWU9e2ludGVybmFsQ29udGV4dH0+XG4gICAgICAgIDxGdW5jdGlvbkNvbnRleHQuUHJvdmlkZXIgdmFsdWU9e2Z1bmN0aW9uQ29udGV4dH0+XG4gICAgICAgICAgPFZpZXdDb250ZXh0LlByb3ZpZGVyIHZhbHVlPXt2aWV3Q29udGV4dH0+XG4gICAgICAgICAgICA8TGVnYWN5Q29udGV4dC5Qcm92aWRlciB2YWx1ZT17bGVnYWN5Q29udGV4dH0+XG4gICAgICAgICAgICAgIHtjaGlsZHJlbn1cbiAgICAgICAgICAgICAge3BhdGNoZWRTdHlsZU9wdGlvbnMuYXV0b0NlbnRlciAmJiA8QXV0b0NlbnRlciAvPn1cbiAgICAgICAgICAgIDwvTGVnYWN5Q29udGV4dC5Qcm92aWRlcj5cbiAgICAgICAgICA8L1ZpZXdDb250ZXh0LlByb3ZpZGVyPlxuICAgICAgICA8L0Z1bmN0aW9uQ29udGV4dC5Qcm92aWRlcj5cbiAgICAgIDwvSW50ZXJuYWxDb250ZXh0LlByb3ZpZGVyPlxuICAgIDwvUHJvcHNDb250ZXh0LlByb3ZpZGVyPlxuICApO1xufTtcblxuQ29tcG9zZXIuZGVmYXVsdFByb3BzID0ge1xuICBjaGlsZHJlbjogdW5kZWZpbmVkLFxuICBkaXI6IHVuZGVmaW5lZCxcbiAgaGVpZ2h0OiB1bmRlZmluZWQsXG4gIG5vbmNlOiB1bmRlZmluZWQsXG4gIHN0eWxlT3B0aW9uczogdW5kZWZpbmVkLFxuICBzdHlsZVNldDogdW5kZWZpbmVkXG59O1xuXG5Db21wb3Nlci5wcm9wVHlwZXMgPSB7XG4gIGNoaWxkcmVuOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMuZWxlbWVudCksIFByb3BUeXBlcy5lbGVtZW50XSksXG4gIGRpcjogUHJvcFR5cGVzLm9uZU9mKFsnbHRyJywgJ3J0bCddKSxcbiAgaGVpZ2h0OiBQcm9wVHlwZXMubnVtYmVyLFxuICBub25jZTogUHJvcFR5cGVzLnN0cmluZyxcbiAgbnVtSXRlbXM6IFByb3BUeXBlcy5udW1iZXIuaXNSZXF1aXJlZCxcbiAgc3R5bGVPcHRpb25zOiBQcm9wVHlwZXMuYW55LFxuICBzdHlsZVNldDogUHJvcFR5cGVzLmFueVxufTtcblxuZXhwb3J0IGRlZmF1bHQgQ29tcG9zZXI7XG4iXX0=